<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt æ¨¡æ¿å¡«å…¥å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 2rem;
            font-weight: 600;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .template-title {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
        }

        .edit-template-btn {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .edit-template-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
        }

        .template-display {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            min-height: 100px;
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .placeholder {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            display: inline-block;
            margin: 0 3px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .placeholder:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .filled {
            background: linear-gradient(45deg, #48bb78, #38a169);
            animation: fillAnimation 0.3s ease;
        }

        @keyframes fillAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .section {
            margin-bottom: 25px;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .format-note {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #9a3412;
        }

        .format-tabs {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            background: #f8fafc;
            padding: 6px;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            text-align: center;
        }

        .tab-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            font-weight: 600;
        }

        .tab-content {
            padding: 25px;
            min-height: 100px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .format-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .format-btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .format-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .format-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .format-btn:hover::before {
            left: 100%;
        }

        .format-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .format-btn.active:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            color: white;
        }

        @media (max-width: 768px) {
            .tab-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .tab-btn {
                font-size: 12px;
                padding: 10px 12px;
            }
            
            .format-buttons {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .format-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        .added-format {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 0;
            font-size: 14px;
            color: #234e52;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .remove-format {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-format:hover {
            background: #e53e3e;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-copy {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .btn-copy:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-reset {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
        }

        .btn-clear {
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-clear:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
        }

        /* Modal æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 1.3rem;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin: 15px 0;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .modal textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal input:focus, .modal textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-weight: 500;
            max-width: 300px;
            word-wrap: break-word;
        }

        .notification.show {
            transform: translateX(0);
        }

        .example {
            background: #f0f4f8;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .example h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .example code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .url-share-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .url-share-section h4 {
            margin: 0 0 8px 0;
            color: #0c4a6e;
            font-size: 1rem;
        }

        .btn-share {
            background: linear-gradient(45deg, #0ea5e9, #0284c7);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-share:hover {
            background: linear-gradient(45deg, #0284c7, #0369a1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        .empty-template {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ Prompt æ¨¡æ¿å¡«å…¥å·¥å…·</h1>
        
        <div class="template-header">
            <h2 class="template-title">ğŸ“‹ é»æ“Šä¸‹æ–¹æ¨™ç±¤é€²è¡Œå¡«å…¥</h2>
            <button class="edit-template-btn" onclick="openTemplateEditor()">âœï¸ ç·¨è¼¯æ¨¡æ¿</button>
        </div>

        <div class="template-display" id="templateDisplay">
            <div class="empty-template">
                è«‹é»æ“Šã€Œç·¨è¼¯æ¨¡æ¿ã€é–‹å§‹è¨­å®šä½ çš„ prompt æ¨¡æ¿...
            </div>
        </div>

        <div class="section">
            <h2>ğŸ¨ å¿«é€Ÿæ·»åŠ æ ¼å¼è¦æ±‚</h2>
            
            <div class="format-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('output')">ğŸ“Š è¼¸å‡ºæ ¼å¼</button>
                    <button class="tab-btn" onclick="switchTab('length')">ğŸ“ é•·åº¦æ§åˆ¶</button>
                    <button class="tab-btn" onclick="switchTab('structure')">ğŸ—ï¸ çµæ§‹è¦æ±‚</button>
                    <button class="tab-btn" onclick="switchTab('style')">ğŸ¯ èªè¨€é¢¨æ ¼</button>
                    <button class="tab-btn" onclick="switchTab('special')">ğŸ“‹ ç‰¹æ®Šè¦æ±‚</button>
                </div>
                
                <div class="tab-content">
                    <div class="tab-panel active" id="tab-output">
                        <div class="format-buttons">
                            <button class="format-btn" onclick="addFormat('è«‹å°‡çµæœä»¥è¡¨æ ¼å½¢å¼è¼¸å‡ºã€‚')">è¡¨æ ¼æ ¼å¼</button>
                            <button class="format-btn" onclick="addFormat('è«‹å°‡çµæœä»¥æ¢åˆ—å¼å‘ˆç¾ã€‚')">æ¢åˆ—æ¸…å–®</button>
                            <button class="format-btn" onclick="addFormat('è«‹å°‡çµæœä»¥ JSON æ ¼å¼è¼¸å‡ºã€‚')">JSONæ ¼å¼</button>
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥æ®µè½å½¢å¼è©³ç´°èªªæ˜ã€‚')">æ®µè½èªªæ˜</button>
                        </div>
                    </div>
                    
                    <div class="tab-panel" id="tab-length">
                        <div class="format-buttons">
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥ä¸è¶…é 50 å­—ç°¡æ½”å›ç­”ã€‚')">50å­—å…§</button>
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥ä¸è¶…é 100 å­—èªªæ˜ã€‚')">100å­—å…§</button>
                            <button class="format-btn" onclick="addFormat('è«‹æä¾›è©³ç´°å®Œæ•´çš„åˆ†æã€‚')">è©³ç´°åˆ†æ</button>
                            <button class="format-btn" onclick="addFormat('è«‹æä¾›é‡é»æ‘˜è¦ã€‚')">é‡é»æ‘˜è¦</button>
                        </div>
                    </div>
                    
                    <div class="tab-panel" id="tab-structure">
                        <div class="format-buttons">
                            <button class="format-btn" onclick="addFormat('è«‹åˆ† 3-5 å€‹é‡é»èªªæ˜ã€‚')">åˆ†é»èªªæ˜</button>
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥æ­¥é©Ÿå¼æ–¹å¼èªªæ˜ã€‚')">æ­¥é©Ÿèªªæ˜</button>
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥å•ç­”å½¢å¼å‘ˆç¾ã€‚')">å•ç­”å½¢å¼</button>
                            <button class="format-btn" onclick="addFormat('è«‹é€²è¡Œå„ªç¼ºé»æ¯”è¼ƒã€‚')">æ¯”è¼ƒå°ç…§</button>
                        </div>
                    </div>
                    
                    <div class="tab-panel" id="tab-style">
                        <div class="format-buttons">
                            <button class="format-btn" onclick="addFormat('è«‹ä½¿ç”¨å°ˆæ¥­è¡“èªé€²è¡Œèªªæ˜ã€‚')">å°ˆæ¥­è¡“èª</button>
                            <button class="format-btn" onclick="addFormat('è«‹ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼èªªæ˜ã€‚')">æ·ºé¡¯æ˜“æ‡‚</button>
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥å•†æ¥­å ±å‘Šçš„æ ¼å¼å‘ˆç¾ã€‚')">å•†æ¥­å ±å‘Š</button>
                            <button class="format-btn" onclick="addFormat('è«‹ä»¥å­¸è¡“è«–æ–‡çš„é¢¨æ ¼æ’°å¯«ã€‚')">å­¸è¡“é¢¨æ ¼</button>
                        </div>
                    </div>
                    
                    <div class="tab-panel" id="tab-special">
                        <div class="format-buttons">
                            <button class="format-btn" onclick="addFormat('è«‹æä¾›å…·é«”ä¾‹å­èªªæ˜ã€‚')">åŒ…å«ä¾‹å­</button>
                            <button class="format-btn" onclick="addFormat('è«‹ç›¡é‡æä¾›ç›¸é—œæ•¸æ“šæ”¯æŒã€‚')">æ•¸æ“šæ”¯æŒ</button>
                            <button class="format-btn" onclick="addFormat('è«‹è©•ä¼°å¯è¡Œæ€§ä¸¦èªªæ˜é¢¨éšªã€‚')">å¯è¡Œæ€§åˆ†æ</button>
                            <button class="format-btn" onclick="addFormat('è«‹æä¾›è¡Œå‹•å»ºè­°ã€‚')">è¡Œå‹•å»ºè­°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-action btn-copy" onclick="copyResult()">ğŸ“‹ è¤‡è£½çµæœ</button>
            <button class="btn-action btn-reset" onclick="resetTemplate()">ğŸ”„ é‡ç½®å¡«å…¥</button>
            <button class="btn-action btn-clear" onclick="clearFormats()">ğŸ¨ æ¸…é™¤æ ¼å¼</button>
            <button class="btn-action btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        </div>
    </div>

    <!-- æ¨¡æ¿ç·¨è¼¯ Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <h3>âœï¸ ç·¨è¼¯ Prompt æ¨¡æ¿</h3>
            <div class="example">
                <h4>ä½¿ç”¨èªªæ˜ï¼š</h4>
                <p>åœ¨æ¨¡æ¿ä¸­ç”¨æ–¹æ‹¬è™Ÿ <code>[xxx]</code> æ¨™è¨˜éœ€è¦å¡«å…¥çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š</p>
                <code>è«‹å¹«æˆ‘æ‰¾å‡º [ç”¢å“é¡å‹] åœ¨ [å¸‚å ´å€åŸŸ] çš„ä½¿ç”¨è¡Œç‚ºèˆ‡è³¼è²·è¶¨å‹¢</code>
            </div>
            <textarea id="templateInput" placeholder="è«‹è¼¸å…¥ä½ çš„ prompt æ¨¡æ¿ï¼Œç”¨ [xxx] æ¨™è¨˜éœ€è¦å¡«å…¥çš„åœ°æ–¹...

ç¯„ä¾‹ï¼š
è«‹å¹«æˆ‘æ‰¾å‡º [ç”¢å“é¡å‹/æ—ç¾¤] åœ¨ [å¸‚å ´å€åŸŸ] çš„ä½¿ç”¨è¡Œç‚ºèˆ‡è³¼è²·è¶¨å‹¢ï¼Œä¸¦èªªæ˜ä¸»è¦çš„æ¶ˆè²»å‹•æ©Ÿèˆ‡ç—›é»ã€‚

åˆ†æ [å“ç‰Œåç¨±] åœ¨ [ç«¶çˆ­å°æ‰‹] é¢å‰çš„å„ªå‹¢å’ŒåŠ£å‹¢ï¼Œä¸¦æå‡º [æ”¹å–„å»ºè­°é¡å‹] çš„ç­–ç•¥å»ºè­°ã€‚"></textarea>
            
            <div class="url-share-section">
                <h4>ğŸ”— åˆ†äº«æ¨¡æ¿</h4>
                <p style="color: #718096; font-size: 14px; margin-bottom: 10px;">è¤‡è£½é€£çµä¾†åˆ†äº«ä½ çš„æ¨¡æ¿çµ¦å…¶ä»–äºº</p>
                <button class="btn btn-share" onclick="copyTemplateUrl()">ğŸ“‹ è¤‡è£½åˆ†äº«é€£çµ</button>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeTemplateEditor()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button>
            </div>
        </div>
    </div>

    <!-- å¡«å…¥å…§å®¹ Modal -->
    <div id="fillModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">å¡«å…¥å…§å®¹</h3>
            <p id="modalHint" style="color: #718096; margin-bottom: 10px;"></p>
            <input type="text" id="modalInput" placeholder="è«‹è¼¸å…¥å…§å®¹...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeFillModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmFill()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification">
        å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼
    </div>

    <script>
        let currentPlaceholderIndex = -1;
        let placeholders = [];
        let filledValues = {};
        let addedFormats = [];
        let currentTemplate = '';

        // å®šç¾©æ ¼å¼è¡çªè¦å‰‡
        const formatConflicts = {
            // é•·åº¦æ§åˆ¶ - äº’æ–¥
            length: [
                'è«‹ä»¥ä¸è¶…é 50 å­—ç°¡æ½”å›ç­”ã€‚',
                'è«‹ä»¥ä¸è¶…é 100 å­—èªªæ˜ã€‚',
                'è«‹æä¾›è©³ç´°å®Œæ•´çš„åˆ†æã€‚',
                'è«‹æä¾›é‡é»æ‘˜è¦ã€‚'
            ],
            // è¼¸å‡ºæ ¼å¼ - äº’æ–¥
            outputFormat: [
                'è«‹å°‡çµæœä»¥è¡¨æ ¼å½¢å¼è¼¸å‡ºã€‚',
                'è«‹å°‡çµæœä»¥æ¢åˆ—å¼å‘ˆç¾ã€‚',
                'è«‹å°‡çµæœä»¥ JSON æ ¼å¼è¼¸å‡ºã€‚',
                'è«‹ä»¥æ®µè½å½¢å¼è©³ç´°èªªæ˜ã€‚'
            ],
            // çµæ§‹è¦æ±‚ - éƒ¨åˆ†äº’æ–¥
            structure: [
                'è«‹åˆ† 3-5 å€‹é‡é»èªªæ˜ã€‚',
                'è«‹ä»¥æ­¥é©Ÿå¼æ–¹å¼èªªæ˜ã€‚',
                'è«‹ä»¥å•ç­”å½¢å¼å‘ˆç¾ã€‚'
            ],
            // èªè¨€é¢¨æ ¼ - äº’æ–¥
            style: [
                'è«‹ä½¿ç”¨å°ˆæ¥­è¡“èªé€²è¡Œèªªæ˜ã€‚',
                'è«‹ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼èªªæ˜ã€‚',
                'è«‹ä»¥å•†æ¥­å ±å‘Šçš„æ ¼å¼å‘ˆç¾ã€‚',
                'è«‹ä»¥å­¸è¡“è«–æ–‡çš„é¢¨æ ¼æ’°å¯«ã€‚'
            ]
        };

        const templateDisplay = document.getElementById('templateDisplay');
        const templateModal = document.getElementById('templateModal');
        const fillModal = document.getElementById('fillModal');
        const templateInput = document.getElementById('templateInput');
        const modalInput = document.getElementById('modalInput');
        const modalTitle = document.getElementById('modalTitle');
        const modalHint = document.getElementById('modalHint');

        // åˆå§‹åŒ–
        loadDefaultTemplate();

        function switchTab(tabId) {
            // ç§»é™¤æ‰€æœ‰ tab çš„ active ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // æ¿€æ´»é¸ä¸­çš„ tab
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        function loadDefaultTemplate() {
            // é¦–å…ˆæª¢æŸ¥ URL åƒæ•¸æ˜¯å¦æœ‰æ¨¡æ¿
            const urlParams = new URLSearchParams(window.location.search);
            const urlTemplate = urlParams.get('prompt');
            
            if (urlTemplate) {
                try {
                    // URLSearchParams å·²ç¶“è‡ªå‹•è§£ç¢¼äº†ï¼Œä¸éœ€è¦å†æ¬¡ decodeURIComponent
                    currentTemplate = urlTemplate;
                    templateInput.value = currentTemplate;
                    parseTemplate();
                    console.log('å¾ URL è¼‰å…¥æ¨¡æ¿:', currentTemplate);
                    return;
                } catch (error) {
                    console.error('è§£æ URL åƒæ•¸å¤±æ•—:', error);
                    // å¦‚æœè§£æå¤±æ•—ï¼Œç¹¼çºŒä½¿ç”¨é è¨­æ¨¡æ¿
                }
            }
            
            // ä½¿ç”¨é è¨­æ¨¡æ¿
            currentTemplate = 'è«‹å¹«æˆ‘æ‰¾å‡º [ç”¢å“é¡å‹/æ—ç¾¤] åœ¨ [å¸‚å ´å€åŸŸ] çš„ä½¿ç”¨è¡Œç‚ºèˆ‡è³¼è²·è¶¨å‹¢ï¼Œä¸¦èªªæ˜ä¸»è¦çš„æ¶ˆè²»å‹•æ©Ÿèˆ‡ç—›é»ã€‚';
            templateInput.value = currentTemplate;
            parseTemplate();
        }

        function openTemplateEditor() {
            templateModal.style.display = 'block';
            templateInput.focus();
        }

        function closeTemplateEditor() {
            templateModal.style.display = 'none';
        }

        function saveTemplate() {
            currentTemplate = templateInput.value.trim();
            if (currentTemplate) {
                parseTemplate();
                closeTemplateEditor();
            }
        }

        function parseTemplate() {
            if (!currentTemplate) {
                templateDisplay.innerHTML = '<div class="empty-template">è«‹é»æ“Šã€Œç·¨è¼¯æ¨¡æ¿ã€é–‹å§‹è¨­å®šä½ çš„ prompt æ¨¡æ¿...</div>';
                return;
            }

            // é‡ç½®å¡«å…¥å€¼ä½†ä¿ç•™æ ¼å¼
            filledValues = {};
            
            // æ‰¾å‡ºæ‰€æœ‰å ä½ç¬¦
            const placeholderRegex = /\[([^\]]+)\]/g;
            placeholders = [];
            let match;
            
            while ((match = placeholderRegex.exec(currentTemplate)) !== null) {
                placeholders.push({
                    full: match[0],
                    content: match[1],
                    index: placeholders.length
                });
            }

            renderTemplate();
        }

        function renderTemplate() {
            let template = currentTemplate;
            
            placeholders.forEach((placeholder, index) => {
                const value = filledValues[index];
                const displayText = value || placeholder.content;
                const isFilledClass = value ? 'filled' : '';
                
                const span = `<span class="placeholder ${isFilledClass}" onclick="openFillModal(${index})" title="é»æ“Šå¡«å…¥: ${placeholder.content}">${displayText}</span>`;
                template = template.replace(placeholder.full, span);
            });

            // æ·»åŠ æ ¼å¼è¦æ±‚
            if (addedFormats.length > 0) {
                template += '<br><br>';
                addedFormats.forEach((format, index) => {
                    template += `<div class="added-format">${format}<button class="remove-format" onclick="removeFormat(${index})" title="ç§»é™¤æ­¤æ ¼å¼">Ã—</button></div>`;
                });
            }

            templateDisplay.innerHTML = template;
            updateButtonStates();
        }

        function openFillModal(index) {
            currentPlaceholderIndex = index;
            const placeholder = placeholders[index];
            
            modalTitle.textContent = `å¡«å…¥ï¼š${placeholder.content}`;
            modalHint.textContent = `è«‹ç‚ºã€Œ${placeholder.content}ã€è¼¸å…¥å…·é«”å…§å®¹`;
            modalInput.value = filledValues[index] || '';
            fillModal.style.display = 'block';
            
            setTimeout(() => modalInput.focus(), 100);
        }

        function closeFillModal() {
            fillModal.style.display = 'none';
            currentPlaceholderIndex = -1;
        }

        function confirmFill() {
            const value = modalInput.value.trim();
            
            if (value && currentPlaceholderIndex >= 0) {
                filledValues[currentPlaceholderIndex] = value;
                renderTemplate();
            }
            
            closeFillModal();
        }

        function addFormat(formatText) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨å®Œå…¨ç›¸åŒçš„æ ¼å¼
            if (addedFormats.includes(formatText)) {
                return;
            }

            // æª¢æŸ¥è¡çªä¸¦ç§»é™¤è¡çªçš„æ ¼å¼
            for (const [category, formats] of Object.entries(formatConflicts)) {
                if (formats.includes(formatText)) {
                    // ç§»é™¤åŒé¡åˆ¥çš„å…¶ä»–æ ¼å¼
                    addedFormats = addedFormats.filter(existing => !formats.includes(existing));
                    break;
                }
            }

            // æ·»åŠ æ–°æ ¼å¼
            addedFormats.push(formatText);
            renderTemplate();
            
            // è¦–è¦ºåé¥‹
            highlightFormatButton(formatText);
        }

        function highlightFormatButton(formatText) {
            const buttons = document.querySelectorAll('.format-btn');
            buttons.forEach(btn => {
                if (btn.textContent === getButtonText(formatText)) {
                    btn.style.background = 'linear-gradient(45deg, #48bb78, #38a169)';
                    btn.style.color = 'white';
                    btn.style.transform = 'scale(1.05)';
                    
                    setTimeout(() => {
                        btn.style.background = '';
                        btn.style.color = '';
                        btn.style.transform = '';
                        updateButtonStates(); // ç¢ºä¿ç‹€æ…‹æ­£ç¢ºæ›´æ–°
                    }, 300);
                }
            });
        }

        function getButtonText(formatText) {
            const buttonMap = {
                'è«‹å°‡çµæœä»¥è¡¨æ ¼å½¢å¼è¼¸å‡ºã€‚': 'è¡¨æ ¼æ ¼å¼',
                'è«‹å°‡çµæœä»¥æ¢åˆ—å¼å‘ˆç¾ã€‚': 'æ¢åˆ—æ¸…å–®',
                'è«‹å°‡çµæœä»¥ JSON æ ¼å¼è¼¸å‡ºã€‚': 'JSONæ ¼å¼',
                'è«‹ä»¥æ®µè½å½¢å¼è©³ç´°èªªæ˜ã€‚': 'æ®µè½èªªæ˜',
                'è«‹ä»¥ä¸è¶…é 50 å­—ç°¡æ½”å›ç­”ã€‚': '50å­—å…§',
                'è«‹ä»¥ä¸è¶…é 100 å­—èªªæ˜ã€‚': '100å­—å…§',
                'è«‹æä¾›è©³ç´°å®Œæ•´çš„åˆ†æã€‚': 'è©³ç´°åˆ†æ',
                'è«‹æä¾›é‡é»æ‘˜è¦ã€‚': 'é‡é»æ‘˜è¦',
                'è«‹åˆ† 3-5 å€‹é‡é»èªªæ˜ã€‚': 'åˆ†é»èªªæ˜',
                'è«‹ä»¥æ­¥é©Ÿå¼æ–¹å¼èªªæ˜ã€‚': 'æ­¥é©Ÿèªªæ˜',
                'è«‹ä»¥å•ç­”å½¢å¼å‘ˆç¾ã€‚': 'å•ç­”å½¢å¼',
                'è«‹é€²è¡Œå„ªç¼ºé»æ¯”è¼ƒã€‚': 'æ¯”è¼ƒå°ç…§',
                'è«‹ä½¿ç”¨å°ˆæ¥­è¡“èªé€²è¡Œèªªæ˜ã€‚': 'å°ˆæ¥­è¡“èª',
                'è«‹ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼èªªæ˜ã€‚': 'æ·ºé¡¯æ˜“æ‡‚',
                'è«‹ä»¥å•†æ¥­å ±å‘Šçš„æ ¼å¼å‘ˆç¾ã€‚': 'å•†æ¥­å ±å‘Š',
                'è«‹ä»¥å­¸è¡“è«–æ–‡çš„é¢¨æ ¼æ’°å¯«ã€‚': 'å­¸è¡“é¢¨æ ¼',
                'è«‹æä¾›å…·é«”ä¾‹å­èªªæ˜ã€‚': 'åŒ…å«ä¾‹å­',
                'è«‹ç›¡é‡æä¾›ç›¸é—œæ•¸æ“šæ”¯æŒã€‚': 'æ•¸æ“šæ”¯æŒ',
                'è«‹è©•ä¼°å¯è¡Œæ€§ä¸¦èªªæ˜é¢¨éšªã€‚': 'å¯è¡Œæ€§åˆ†æ',
                'è«‹æä¾›è¡Œå‹•å»ºè­°ã€‚': 'è¡Œå‹•å»ºè­°'
            };
            return buttonMap[formatText] || '';
        }

        function updateButtonStates() {
            const buttons = document.querySelectorAll('.format-btn');
            buttons.forEach(btn => {
                const formatText = getFormatTextFromButton(btn.textContent);
                if (addedFormats.includes(formatText)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getFormatTextFromButton(buttonText) {
            const reverseButtonMap = {
                'è¡¨æ ¼æ ¼å¼': 'è«‹å°‡çµæœä»¥è¡¨æ ¼å½¢å¼è¼¸å‡ºã€‚',
                'æ¢åˆ—æ¸…å–®': 'è«‹å°‡çµæœä»¥æ¢åˆ—å¼å‘ˆç¾ã€‚',
                'JSONæ ¼å¼': 'è«‹å°‡çµæœä»¥ JSON æ ¼å¼è¼¸å‡ºã€‚',
                'æ®µè½èªªæ˜': 'è«‹ä»¥æ®µè½å½¢å¼è©³ç´°èªªæ˜ã€‚',
                '50å­—å…§': 'è«‹ä»¥ä¸è¶…é 50 å­—ç°¡æ½”å›ç­”ã€‚',
                '100å­—å…§': 'è«‹ä»¥ä¸è¶…é 100 å­—èªªæ˜ã€‚',
                'è©³ç´°åˆ†æ': 'è«‹æä¾›è©³ç´°å®Œæ•´çš„åˆ†æã€‚',
                'é‡é»æ‘˜è¦': 'è«‹æä¾›é‡é»æ‘˜è¦ã€‚',
                'åˆ†é»èªªæ˜': 'è«‹åˆ† 3-5 å€‹é‡é»èªªæ˜ã€‚',
                'æ­¥é©Ÿèªªæ˜': 'è«‹ä»¥æ­¥é©Ÿå¼æ–¹å¼èªªæ˜ã€‚',
                'å•ç­”å½¢å¼': 'è«‹ä»¥å•ç­”å½¢å¼å‘ˆç¾ã€‚',
                'æ¯”è¼ƒå°ç…§': 'è«‹é€²è¡Œå„ªç¼ºé»æ¯”è¼ƒã€‚',
                'å°ˆæ¥­è¡“èª': 'è«‹ä½¿ç”¨å°ˆæ¥­è¡“èªé€²è¡Œèªªæ˜ã€‚',
                'æ·ºé¡¯æ˜“æ‡‚': 'è«‹ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼èªªæ˜ã€‚',
                'å•†æ¥­å ±å‘Š': 'è«‹ä»¥å•†æ¥­å ±å‘Šçš„æ ¼å¼å‘ˆç¾ã€‚',
                'å­¸è¡“é¢¨æ ¼': 'è«‹ä»¥å­¸è¡“è«–æ–‡çš„é¢¨æ ¼æ’°å¯«ã€‚',
                'åŒ…å«ä¾‹å­': 'è«‹æä¾›å…·é«”ä¾‹å­èªªæ˜ã€‚',
                'æ•¸æ“šæ”¯æŒ': 'è«‹ç›¡é‡æä¾›ç›¸é—œæ•¸æ“šæ”¯æŒã€‚',
                'å¯è¡Œæ€§åˆ†æ': 'è«‹è©•ä¼°å¯è¡Œæ€§ä¸¦èªªæ˜é¢¨éšªã€‚',
                'è¡Œå‹•å»ºè­°': 'è«‹æä¾›è¡Œå‹•å»ºè­°ã€‚'
            };
            return reverseButtonMap[buttonText] || '';
        }

        function removeFormat(index) {
            addedFormats.splice(index, 1);
            renderTemplate();
        }

        function resetTemplate() {
            filledValues = {};
            renderTemplate();
        }

        function clearFormats() {
            addedFormats = [];
            renderTemplate();
        }

        function clearAll() {
            currentTemplate = '';
            templateInput.value = '';
            filledValues = {};
            placeholders = [];
            addedFormats = [];
            templateDisplay.innerHTML = '<div class="empty-template">è«‹é»æ“Šã€Œç·¨è¼¯æ¨¡æ¿ã€é–‹å§‹è¨­å®šä½ çš„ prompt æ¨¡æ¿...</div>';
        }

        function copyTemplateUrl() {
            const currentPrompt = templateInput.value.trim();
            if (!currentPrompt) {
                showNotification('âš ï¸ è«‹å…ˆè¼¸å…¥æ¨¡æ¿å…§å®¹', '#f56565');
                return;
            }

            try {
                // URL encode æ¨¡æ¿å…§å®¹
                const encodedPrompt = encodeURIComponent(currentPrompt);
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?prompt=${encodedPrompt}`;
                
                // è¤‡è£½åˆ°å‰ªè²¼ç°¿
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showNotification('ğŸ”— åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', '#0ea5e9');
                    }).catch((error) => {
                        console.error('Clipboard API failed:', error);
                        fallbackCopyToClipboard(shareUrl);
                    });
                } else {
                    fallbackCopyToClipboard(shareUrl);
                }
            } catch (error) {
                console.error('ç”¢ç”Ÿåˆ†äº«é€£çµå¤±æ•—:', error);
                showNotification('âŒ ç”¢ç”Ÿåˆ†äº«é€£çµå¤±æ•—', '#f56565');
            }
        }

        function fallbackCopyToClipboard(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showNotification('ğŸ”— åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', '#0ea5e9');
                } else {
                    showNotification('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', '#f56565');
                }
            } catch (error) {
                console.error('Fallback copy failed:', error);
                showNotification('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', '#f56565');
            }
        }

        function copyResult() {
            let result = currentTemplate;
            
            placeholders.forEach((placeholder, index) => {
                const value = filledValues[index];
                if (value) {
                    result = result.replace(placeholder.full, value);
                }
            });

            // æ·»åŠ æ ¼å¼è¦æ±‚åˆ°çµæœä¸­
            if (addedFormats.length > 0) {
                result += '\n\n' + addedFormats.join(' ');
            }

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(result).then(() => {
                    showNotification('ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                }).catch((error) => {
                    console.error('Clipboard API failed:', error);
                    fallbackCopyToClipboard(result);
                });
            } else {
                fallbackCopyToClipboard(result);
            }
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (e) => {
            // ESC é—œé–‰ modal
            if (e.key === 'Escape') {
                if (fillModal.style.display === 'block') {
                    closeFillModal();
                }
                if (templateModal.style.display === 'block') {
                    closeTemplateEditor();
                }
            }
            
            // Enter ç¢ºèª
            if (e.key === 'Enter') {
                if (fillModal.style.display === 'block') {
                    confirmFill();
                } else if (templateModal.style.display === 'block' && e.ctrlKey) {
                    saveTemplate();
                }
            }
            
            // Ctrl+C è¤‡è£½çµæœ
            if (e.ctrlKey && e.key === 'c' && fillModal.style.display !== 'block' && templateModal.style.display !== 'block') {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    copyResult();
                }
            }
        });

        // é»æ“Š modal å¤–éƒ¨é—œé–‰
        fillModal.addEventListener('click', (e) => {
            if (e.target === fillModal) {
                closeFillModal();
            }
        });

        templateModal.addEventListener('click', (e) => {
            if (e.target === templateModal) {
                closeTemplateEditor();
            }
        });

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, color = '#48bb78') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = color;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>