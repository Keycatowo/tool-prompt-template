name: æŒçºŒæ•´åˆæª¢æŸ¥

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  # æª¢æŸ¥æ–‡ä»¶å®Œæ•´æ€§
  check-files:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: æª¢æŸ¥å¿…è¦æª”æ¡ˆ
        run: |
          echo "ğŸ” æª¢æŸ¥å¿…è¦æª”æ¡ˆ..."
          
          # æª¢æŸ¥ä¸»è¦æª”æ¡ˆ
          if [ ! -f "index.html" ]; then
            echo "âŒ ç¼ºå°‘ index.html"
            exit 1
          fi
          
          if [ ! -f "package.json" ]; then
            echo "âŒ ç¼ºå°‘ package.json"
            exit 1
          fi
          
          if [ ! -f "README.md" ]; then
            echo "âŒ ç¼ºå°‘ README.md"
            exit 1
          fi
          
          if [ ! -f "CHANGELOG.md" ]; then
            echo "âŒ ç¼ºå°‘ CHANGELOG.md"
            exit 1
          fi
          
          if [ ! -d "changelogs" ]; then
            echo "âŒ ç¼ºå°‘ changelogs è³‡æ–™å¤¾"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆéƒ½å­˜åœ¨"

      - name: æª¢æŸ¥ package.json æ ¼å¼
        run: |
          echo "ğŸ“‹ æª¢æŸ¥ package.json æ ¼å¼..."
          if ! python -m json.tool package.json > /dev/null 2>&1; then
            echo "âŒ package.json æ ¼å¼éŒ¯èª¤"
            exit 1
          fi
          echo "âœ… package.json æ ¼å¼æ­£ç¢º"

      - name: æª¢æŸ¥ HTML èªæ³•
        run: |
          echo "ğŸ” æª¢æŸ¥ HTML èªæ³•..."
          # æª¢æŸ¥ index.html æ˜¯å¦åŒ…å«å¿…è¦çš„æ¨™ç±¤
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "âŒ ç¼ºå°‘ DOCTYPE è²æ˜"
            exit 1
          fi
          
          if ! grep -q "<title>" index.html; then
            echo "âŒ ç¼ºå°‘ title æ¨™ç±¤"
            exit 1
          fi
          
          if ! grep -q "viewport" index.html; then
            echo "âŒ ç¼ºå°‘ viewport meta æ¨™ç±¤"
            exit 1
          fi
          
          echo "âœ… HTML èªæ³•æª¢æŸ¥é€šé"

      - name: æª¢æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          echo "ğŸ” æª¢æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§..."
          
          # å¾ package.json è®€å–ç‰ˆæœ¬
          PACKAGE_VERSION=$(python -c "import json; print(json.load(open('package.json'))['version'])")
          echo "ğŸ“‹ package.json ç‰ˆæœ¬: $PACKAGE_VERSION"
          
          # æª¢æŸ¥å°æ‡‰çš„ changelog æ˜¯å¦å­˜åœ¨
          if [ ! -f "changelogs/v${PACKAGE_VERSION}.md" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„ changelog æ–‡ä»¶ changelogs/v${PACKAGE_VERSION}.md"
            echo "é€™åœ¨é–‹ç™¼éç¨‹ä¸­æ˜¯æ­£å¸¸çš„ï¼Œä½†ç™¼ä½ˆå‰è«‹ç¢ºä¿å‰µå»º"
          else
            echo "âœ… æ‰¾åˆ°å°æ‡‰çš„ changelog æ–‡ä»¶"
          fi

  # æ¸¬è©¦æœ¬åœ°æœå‹™å™¨
  test-server:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: æ¸¬è©¦æœ¬åœ°æœå‹™å™¨
        run: |
          echo "ğŸš€ æ¸¬è©¦æœ¬åœ°æœå‹™å™¨..."
          
          # å•Ÿå‹•æœ¬åœ°æœå‹™å™¨
          python -m http.server 8000 &
          SERVER_PID=$!
          
          # ç­‰å¾…æœå‹™å™¨å•Ÿå‹•
          sleep 3
          
          # æ¸¬è©¦æœå‹™å™¨æ˜¯å¦å›æ‡‰
          if curl -f http://localhost:8000/ > /dev/null 2>&1; then
            echo "âœ… æœ¬åœ°æœå‹™å™¨æ¸¬è©¦é€šé"
          else
            echo "âŒ æœ¬åœ°æœå‹™å™¨æ¸¬è©¦å¤±æ•—"
            exit 1
          fi
          
          # åœæ­¢æœå‹™å™¨
          kill $SERVER_PID